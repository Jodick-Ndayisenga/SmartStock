// app/(tabs)/record-sale.tsx
import React, { useState, useEffect } from 'react';
import { 
  View, 
  ScrollView, 
  Alert, 
  TouchableOpacity, 
  Animated,
  KeyboardAvoidingView,
  Platform,
  Dimensions,
  Image
} from 'react-native';
import { useRouter, useLocalSearchParams } from 'expo-router';
import database from '@/database';
import { Q } from '@nozbe/watermelondb';
import { useTranslation } from 'react-i18next';
import { Ionicons } from '@expo/vector-icons';

// Components
import PremiumHeader from '@/components/layout/PremiumHeader';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Card, CardContent, CardHeader } from '@/components/ui/Card';
import { ThemedText } from '@/components/ui/ThemedText';
import { Loading } from '@/components/ui/Loading';
import { EmptyState } from '@/components/ui/EmptyState';
import { StockStatusBadge } from '@/components/ui/StockStatusBadge';

// Hooks
import { useAuth } from '@/context/AuthContext';

// Models
import { Product } from '@/database/models/Product';
import { StockMovement } from '@/database/models/StockMovement';
import { set } from 'zod';

//const { width: SCREEN_WIDTH } = Dimensions.get('window');

interface CartItem {
  id: string;
  productId: string;
  productName: string;
  quantity: number;
  unit: string;
  pricePerUnit: number;
  totalPrice: number;
  currentStock: number;
  imageUrl?: string;
  baseUnit: string;
  unitType: string;
}

interface QuickAmount {
  label: string;
  value: number;
  unit?: string;
}

export default function RecordSaleScreen() {
  const router = useRouter();
  const params = useLocalSearchParams();
  const { t } = useTranslation();
  const { currentShop , user} = useAuth();
  const [loading, setLoading] = useState(true);
  const [products, setProducts] = useState<Product[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [cart, setCart] = useState<CartItem[]>([]);
  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
  const [quantity, setQuantity] = useState('');
  const [selectedUnit, setSelectedUnit] = useState('');
  const [quickAmounts, setQuickAmounts] = useState<QuickAmount[]>([]);
  const [cartAnimation] = useState(new Animated.Value(0));

  const productIdFromParams = params.productId as string;

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    if (productIdFromParams && products.length > 0) {
      const product = products.find(p => p.id === productIdFromParams);
      if (product) {
        setSelectedProduct(product);
        setSelectedUnit(product.sellingUnit);
        generateQuickAmounts(product);
      }
    }
  }, [productIdFromParams, products]);

  const loadData = async () => {
    try {
      setLoading(true);
      

      if (currentShop) {
        const productsData = await database.get<Product>('products')
          .query(
            Q.where('shop_id', currentShop.id),
            Q.where('is_active', true)
          )
          .fetch();
        setProducts(productsData);
      }
    } catch (error) {
      console.error('Error loading data:', error);
      Alert.alert('Error', 'Failed to load products');
    } finally {
      setLoading(false);
    }
  };

  const generateQuickAmounts = (product: Product) => {
    const amounts: QuickAmount[] = [];
    
    switch (product.unitType) {
      case 'weight':
        amounts.push(
          { label: '250g', value: 0.25, unit: 'kg' },
          { label: '500g', value: 0.5, unit: 'kg' },
          { label: '1kg', value: 1, unit: 'kg' },
          { label: '2kg', value: 2, unit: 'kg' },
          { label: '5kg', value: 5, unit: 'kg' }
        );
        break;
      case 'volume':
        amounts.push(
          { label: '250ml', value: 0.25, unit: 'l' },
          { label: '500ml', value: 0.5, unit: 'l' },
          { label: '1L', value: 1, unit: 'l' },
          { label: '2L', value: 2, unit: 'l' },
          { label: '5L', value: 5, unit: 'l' }
        );
        break;
      case 'piece':
      default:
        amounts.push(
          { label: '1', value: 1 },
          { label: '2', value: 2 },
          { label: '5', value: 5 },
          { label: '10', value: 10 },
          { label: '20', value: 20 }
        );
        break;
    }
    
    setQuickAmounts(amounts);
  };

  const getProductStock = async (productId: string): Promise<number> => {
    const movements = await database.get<StockMovement>('stock_movements')
      .query(Q.where('product_id', productId))
      .fetch();
    
    let stock = 0;
    movements.forEach(movement => {
      if (movement.movementType === 'IN') {
        stock += movement.quantity;
      } else if (movement.movementType === 'SALE') {
        stock -= movement.quantity;
      }
    });
    
    return stock;
  };

  const calculatePrice = (product: Product, qty: number, unit: string): number => {
    if (unit === product.baseUnit) {
      return qty * product.sellingPricePerBase;
    }
    
    // Convert to base unit for calculation
    const baseQuantity = product.convertToBaseUnit(qty, unit);
    return baseQuantity * product.sellingPricePerBase;
  };

  const addToCart = async () => {
    if (!selectedProduct || !quantity || !currentShop) return;

    const qty = parseFloat(quantity);
    if (isNaN(qty) || qty <= 0) {
      Alert.alert('Error', 'Please enter a valid quantity');
      return;
    }

    const currentStock = await getProductStock(selectedProduct.id);
    const quantityInBaseUnit = selectedProduct.convertToBaseUnit(qty, selectedUnit);
    
    if (quantityInBaseUnit > currentStock) {
      Alert.alert('Error', `Only ${currentStock} ${selectedProduct.baseUnit} available in stock`);
      return;
    }

    const totalPrice = calculatePrice(selectedProduct, qty, selectedUnit);
    const cartItem: CartItem = {
      id: `${selectedProduct.id}-${Date.now()}`,
      productId: selectedProduct.id,
      productName: selectedProduct.name,
      quantity: qty,
      unit: selectedUnit,
      pricePerUnit: selectedProduct.sellingPricePerBase,
      totalPrice,
      currentStock: currentStock - quantityInBaseUnit,
      imageUrl: selectedProduct.imageUrl,
      baseUnit: selectedProduct.baseUnit,
      unitType: selectedProduct.unitType,
    };

    setCart(prev => [...prev, cartItem]);
    
    // Animate cart addition
    Animated.sequence([
      Animated.timing(cartAnimation, {
        toValue: 1,
        duration: 200,
        useNativeDriver: true,
      }),
      Animated.timing(cartAnimation, {
        toValue: 0,
        duration: 200,
        useNativeDriver: true,
      }),
    ]).start();

    resetProductSelection();
  };

  const resetProductSelection = () => {
    setSelectedProduct(null);
    setQuantity('');
    setSelectedUnit('');
    setQuickAmounts([]);
  };

  const removeFromCart = (itemId: string) => {
    setCart(prev => prev.filter(item => item.id !== itemId));
  };

  const updateCartQuantity = (itemId: string, newQuantity: number) => {
    if (newQuantity <= 0) {
      removeFromCart(itemId);
      return;
    }

    setCart(prev => prev.map(item => {
      if (item.id === itemId) {
        const totalPrice = calculatePrice(
          products.find(p => p.id === item.productId)!,
          newQuantity,
          item.unit
        );
        return { ...item, quantity: newQuantity, totalPrice };
      }
      return item;
    }));
  };

  const quickAddToCart = async (product: Product, quickAmount: QuickAmount) => {
    const currentStock = await getProductStock(product.id);
    const quantityInBaseUnit = product.convertToBaseUnit(quickAmount.value, quickAmount.unit || product.sellingUnit);
    
    if (quantityInBaseUnit > currentStock) {
      Alert.alert('Error', `Only ${currentStock} ${product.baseUnit} available in stock`);
      return;
    }

    const totalPrice = calculatePrice(product, quickAmount.value, quickAmount.unit || product.sellingUnit);
    const cartItem: CartItem = {
      id: `${product.id}-${Date.now()}`,
      productId: product.id,
      productName: product.name,
      quantity: quickAmount.value,
      unit: quickAmount.unit || product.sellingUnit,
      pricePerUnit: product.sellingPricePerBase,
      totalPrice,
      currentStock: currentStock - quantityInBaseUnit,
      imageUrl: product.imageUrl,
      baseUnit: product.baseUnit,
      unitType: product.unitType,
    };

    setCart(prev => [...prev, cartItem]);
    
    Animated.sequence([
      Animated.timing(cartAnimation, {
        toValue: 1,
        duration: 200,
        useNativeDriver: true,
      }),
      Animated.timing(cartAnimation, {
        toValue: 0,
        duration: 200,
        useNativeDriver: true,
      }),
    ]).start();
  };

  const totalAmount = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

  const processSale = async () => {
    if (!currentShop || cart.length === 0) return;

    try {
      await database.write(async () => {
        for (const item of cart) {
          const product = products.find(p => p.id === item.productId);
          if (!product) continue;

        // Convert to base units for storage & stock update
          const quantityInBaseUnit = product.convertToBaseUnit(item.quantity, item.unit);

          // 1. Create SALE movement
          await database.get<StockMovement>('stock_movements').create(movement => {

            movement.productId = item.productId;
              movement.shopId = currentShop.id;
              movement.quantity = quantityInBaseUnit;
              movement.movementType = 'SALE';
              movement.notes = 'Stock added via product edit';
              movement.recordedBy = user?.id;
              movement.timestamp = Date.now();
          });

          // 2. ✅ Atomically update product.stockQuantity
          await product.update(p => {
            p.stockQuantity = Math.max(0, (p.stockQuantity || 0) - quantityInBaseUnit);
          });


          setCart([]);

          router.replace('/(tabs)/products');// Just a placeholder ID
        }
      });

      Alert.alert(
        'Sale Completed!',
        `Successfully sold ${totalItems} items for ₣${totalAmount.toLocaleString()}`,
        [{ text: 'OK', onPress: () => router.back() }]
      );
    } catch (error) {
      console.error('Error recording sale:', error);
      Alert.alert('Error', 'Failed to record sale');
    }
  };

  const filteredProducts = products.filter(product =>
    product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    product.sku?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  if (loading) {
    return (
      <View className="flex-1 bg-surface-soft dark:bg-dark-surface-soft">
        <PremiumHeader title="Record Sale" showBackButton />
        <Loading />
      </View>
    );
  }

  if (!currentShop) {
    return (
      <View className="flex-1 bg-surface-soft dark:bg-dark-surface-soft">
        <PremiumHeader title="Record Sale" showBackButton />
        <EmptyState
          icon="business-outline"
          title="No Shop Found"
          description="Create a shop first to record sales"
          action={{
            label: "Create Shop",
            onPress: () => router.push('/(auth)/create-shop')
          }}
        />
      </View>
    );
  }

  return (
    <View className="flex-1 bg-surface-soft dark:bg-dark-surface-soft">
      <PremiumHeader 
        title="Record Sale"
        searchable searchPlaceholder="Search products by name or SKU..."
        
        //onSearchChange={setSearchQuery}
      />

      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        className="flex-1"
      >
        <View className="flex-1">
          {/* Cart Summary - Fixed at top */}
          {cart.length > 0 && (
            <Animated.View 
              style={{
                transform: [{
                  scale: cartAnimation.interpolate({
                    inputRange: [0, 1],
                    outputRange: [1, 1.05]
                  })
                }]
              }}
              className="bg-brand/10 border-b border-brand/20"
            >
              <Card variant="filled" className="m-0 border-0">
                <CardContent className="p-4">
                  <View className="flex-row justify-between items-center">
                    <View>
                      <ThemedText variant="brand" size="lg" className="font-semibold">
                        ₣{totalAmount.toLocaleString()}
                      </ThemedText>
                      <ThemedText variant="muted" size="sm">
                        {cart.length} item{cart.length > 1 ? 's' : ''} • {totalItems} units
                      </ThemedText>
                    </View>
                    <Button
                      variant="default"
                      onPress={processSale}
                      icon="checkmark-circle"
                    >
                      Complete Sale
                    </Button>
                  </View>
                </CardContent>
              </Card>
            </Animated.View>
          )}

          <ScrollView 
            className="flex-1"
            showsVerticalScrollIndicator={false}
            contentContainerStyle={{ paddingBottom: 100 }}
          >
            <View className="p-4">
              {/* Product Selection */}
              {!selectedProduct ? (
                <Card variant="elevated" className="mb-4 bg-surface dark:bg-dark-surface">
                  {/* <CardHeader
                    title="Select Products"
                    subtitle="Search and add products to cart"
                  /> */}
                  <CardContent className="p-4">
                    {/* <SearchInput
                      placeholder="Search products by name or SKU..."
                      value={searchQuery}
                      onChangeText={setSearchQuery}
                      onClear={() => setSearchQuery('')}
                    /> */}

                    {/* Quick Sell Products */}
                    {/* <View className="mt-4">
                      <ThemedText variant="label" className="mb-3">
                        Quick Sell - Top Products
                      </ThemedText>
                      <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                        <View className="flex-row gap-3">
                          {filteredProducts.slice(0, 8).map(product => (
                            <TouchableOpacity
                              key={product.id}
                              onPress={() => {
                                setSelectedProduct(product);
                                setSelectedUnit(product.sellingUnit);
                                generateQuickAmounts(product);
                              }}
                              className="w-24 items-center"
                            >
                              <View className="w-16 h-16 rounded-xl bg-surface-muted dark:bg-dark-surface-muted items-center justify-center mb-2 overflow-hidden">
                                {product.imageUrl ? (
                                  <Image 
                                    source={{ uri: product.imageUrl }} 
                                    className="w-full h-full"
                                    resizeMode="cover"
                                  />
                                ) : (
                                  <Ionicons name="cube-outline" size={24} color="#94a3b8" />
                                )}
                              </View>
                              <ThemedText 
                                variant="default" 
                                size="sm" 
                                numberOfLines={2}
                                className="text-center"
                              >
                                {product.name}
                              </ThemedText>
                              <ThemedText variant="muted" size="xs" className="text-center">
                                ₣{product.sellingPricePerBase}
                              </ThemedText>
                            </TouchableOpacity>
                          ))}
                        </View>
                      </ScrollView>
                    </View> */}

                    {/* All Products List */}
                    <View className="mt-6">
                      <ThemedText variant="label" className="mb-3">
                        All Products
                      </ThemedText>
                      <View className="gap-2">
                        {filteredProducts.map(product => (
                          <TouchableOpacity
                            key={product.id}
                            onPress={() => {
                              setSelectedProduct(product);
                              setSelectedUnit(product.sellingUnit);
                              generateQuickAmounts(product);
                            }}
                            className="flex-row items-center p-3 bg-surface dark:bg-dark-surface rounded-lg border border-border dark:border-dark-border"
                          >
                            <View className="w-12 h-12 rounded-lg bg-surface-muted dark:bg-dark-surface-muted items-center justify-center mr-3 overflow-hidden">
                              {product.imageUrl ? (
                                <Image 
                                  source={{ uri: product.imageUrl }} 
                                  className="w-full h-full"
                                  resizeMode="cover"
                                />
                              ) : (
                                <Ionicons name="cube-outline" size={20} color="#94a3b8" />
                              )}
                            </View>
                            <View className="flex-1">
                              <ThemedText variant="default" size="base" className="font-medium">
                                {product.name}
                              </ThemedText>
                              <ThemedText variant="muted" size="sm">
                                FBU {product.stockQuantity} / {product.sellingUnit}
                              </ThemedText>
                            </View>
                            <Ionicons name="chevron-forward" size={20} color="#64748b" />
                          </TouchableOpacity>
                        ))}
                      </View>
                    </View>
                  </CardContent>
                </Card>
              ) : (
                /* Product Details & Quantity Selection */
                <Card variant="elevated" className="mb-4">
                  <CardHeader
                    title={selectedProduct.name}
                    subtitle={`Add quantity to cart`}
                    action={
                      <Button
                        variant="destructive"
                        size="sm"
                        onPress={resetProductSelection}
                        icon="close"
                      >Close</Button>
                    }
                  />
                  <CardContent className="p-4">
                    {/* Product Info */}
                    <View className="flex-row items-center mb-6 p-4 bg-surface-soft dark:bg-dark-surface-soft rounded-lg">
                      <View className="w-16 h-16 rounded-lg bg-surface-muted dark:bg-dark-surface-muted items-center justify-center mr-4 overflow-hidden">
                        {selectedProduct.imageUrl ? (
                          <Image 
                            source={{ uri: selectedProduct.imageUrl }} 
                            className="w-full h-full"
                            resizeMode="cover"
                          />
                        ) : (
                          <Ionicons name="cube-outline" size={24} color="#94a3b8" />
                        )}
                      </View>
                      <View className="flex-1">
                        <ThemedText variant="heading" size="lg" className="mb-1">
                          {selectedProduct.name}
                        </ThemedText>
                        <ThemedText variant="muted" size="sm" className="mb-1">
                          FBU {selectedProduct.sellingPricePerBase} per {selectedProduct.baseUnit}
                        </ThemedText>
                        <StockStatusBadge 
                          status={getStockStatus(selectedProduct.stockQuantity)} // You'd calculate actual stock
                          size="sm"
                          quantity={selectedProduct.stockQuantity}
                        />
                      </View>
                    </View>

                    {/* Quick Amount Buttons */}
                    <View className="mb-6">
                      <ThemedText variant="label" className="mb-3">
                        Quick Add
                      </ThemedText>
                      <View className="flex-row flex-wrap gap-2">
                        {quickAmounts.map((amount, index) => (
                          <TouchableOpacity
                            key={index}
                            onPress={() => quickAddToCart(selectedProduct, amount)}
                            className="px-4 py-3 bg-surface dark:bg-dark-surface rounded-lg border border-border dark:border-dark-border active:bg-surface-soft dark:active:bg-dark-surface-soft"
                          >
                            <ThemedText variant="default" size="base" className="font-medium">
                              {amount.label}
                            </ThemedText>
                          </TouchableOpacity>
                        ))}
                      </View>
                    </View>

                    {/* Custom Quantity Input */}
                    <View className="mb-6">
                      
                      <View className="flex-row items-center gap-3">
                        <View className="flex-1">
                          <ThemedText variant="label" className="mb-3">
                            Custom Quantity
                          </ThemedText>
                          <Input
                            placeholder={`Enter quantity in ${selectedUnit}`}
                            value={quantity}
                            onChangeText={setQuantity}
                            keyboardType="phone-pad"
                          />
                        </View>
                        <View className="w-24">
                          <ThemedText variant="muted" size="sm" className=" text-center">
                            Unit
                          </ThemedText>
                          <View className="flex-row items-center justify-center px-3 py-3 bg-surface dark:bg-dark-surface rounded-base border border-border dark:border-dark-border">
                            <ThemedText variant="default" size="base">
                              {selectedUnit}
                            </ThemedText>
                          </View>
                        </View>
                      </View>
                    </View>

                    {/* Quantity Adjuster */}
                    <View className="mb-6">
                      <ThemedText variant="label" className="mb-3">
                        Adjust Quantity
                      </ThemedText>
                      <View className="flex-row items-center justify-between bg-surface dark:bg-dark-surface rounded-xl p-1 border border-border dark:border-dark-border">
                        <TouchableOpacity
                          onPress={() => {
                            const current = parseFloat(quantity) || 0;
                            setQuantity(Math.max(0, current - 1).toString());
                          }}
                          className="w-12 h-12 items-center justify-center rounded-lg active:bg-surface-soft dark:active:bg-dark-surface-soft"
                        >
                          <Ionicons name="remove" size={24} color="#64748b" />
                        </TouchableOpacity>
                        
                        <View className="flex-1 items-center">
                          <ThemedText variant="heading" size="xl">
                            {quantity || '0'}
                          </ThemedText>
                          <ThemedText variant="muted" size="sm">
                            {selectedUnit}
                          </ThemedText>
                        </View>

                        <TouchableOpacity
                          onPress={() => {
                            const current = parseFloat(quantity) || 0;
                            setQuantity((current + 1).toString());
                          }}
                          className="w-12 h-12 items-center justify-center rounded-lg active:bg-surface-soft dark:active:bg-dark-surface-soft"
                        >
                          <Ionicons name="add" size={24} color="#64748b" />
                        </TouchableOpacity>
                      </View>
                    </View>

                    {/* Add to Cart Button */}
                    <Button
                      variant="default"
                      size="lg"
                      onPress={addToCart}
                      disabled={!quantity || parseFloat(quantity) <= 0}
                      icon="cart"
                    >
                      Add to Cart - ₣{quantity ? calculatePrice(selectedProduct, parseFloat(quantity), selectedUnit).toLocaleString() : '0'}
                    </Button>
                  </CardContent>
                </Card>
              )}

              {/* Cart Items */}
              {cart.length > 0 && (
                <Card variant="elevated">
                  <CardHeader
                    title="Current Sale Items"
                    subtitle={`${cart.length} product${cart.length > 1 ? 's' : ''} in cart`}
                  />
                  <CardContent className="p-0">
                    {cart.map((item, index) => (
                      <View
                        key={item.id}
                        className={`flex-row items-center p-4 ${
                          index < cart.length - 1 ? 'border-b border-border dark:border-dark-border' : ''
                        }`}
                      >
                        <View className="w-12 h-12 rounded-lg bg-surface-muted dark:bg-dark-surface-muted items-center justify-center mr-3 overflow-hidden">
                          {item.imageUrl ? (
                            <Image 
                              source={{ uri: item.imageUrl }} 
                              className="w-full h-full"
                              resizeMode="cover"
                            />
                          ) : (
                            <Ionicons name="cube-outline" size={20} color="#94a3b8" />
                          )}
                        </View>
                        
                        <View className="flex-1">
                          <ThemedText variant="default" size="base" className="font-medium">
                            {item.productName}
                          </ThemedText>
                          <ThemedText variant="muted" size="sm">
                            {item.quantity} {item.unit} × ₣{item.pricePerUnit}
                          </ThemedText>
                        </View>

                        <View className="items-end">
                          <ThemedText variant="heading" size="base">
                            ₣{item.totalPrice.toLocaleString()}
                          </ThemedText>
                          
                          <View className="flex-row items-center space-x-2 mt-1">
                            <TouchableOpacity
                              onPress={() => updateCartQuantity(item.id, item.quantity - 1)}
                              className="w-6 h-6 items-center justify-center rounded-sm bg-surface-soft dark:bg-dark-surface-soft"
                            >
                              <Ionicons name="remove" size={14} color="#64748b" />
                            </TouchableOpacity>
                            
                            <ThemedText variant="muted" size="sm">
                              {item.quantity}
                            </ThemedText>
                            
                            <TouchableOpacity
                              onPress={() => updateCartQuantity(item.id, item.quantity + 1)}
                              className="w-6 h-6 items-center justify-center rounded-sm bg-surface-soft dark:bg-dark-surface-soft"
                            >
                              <Ionicons name="add" size={14} color="#64748b" />
                            </TouchableOpacity>
                          </View>
                        </View>

                        <TouchableOpacity
                          onPress={() => removeFromCart(item.id)}
                          className="ml-3 p-2"
                        >
                          <Ionicons name="trash-outline" size={18} color="#ef4444" />
                        </TouchableOpacity>
                      </View>
                    ))}
                  </CardContent>
                </Card>
              )}
            </View>
          </ScrollView>
        </View>
      </KeyboardAvoidingView>
    </View>
  );
}

// Helper function for stock status (you'll implement actual stock calculation)
const getStockStatus = (stock: number, threshold: number = 10) => {
  if (stock === 0) return 'out-of-stock';
  if (stock <= threshold) return 'low-stock';
  return 'in-stock';
};